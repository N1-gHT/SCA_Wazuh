# Security Configuration Assessment
# CIS Checks for Debia Linux 12
#
# This program is an improved version of the cis_debian12.yml from Wazuh
# You can found it at the following links : 
# https://github.com/wazuh/wazuh/blob/main/ruleset/sca/debian/cis_debian12.yml
#
#
# Based on : 
# Center for Internet Security Debian Linux 12 Benchmark v1.1.0 - 26-09-2024

policy:
  id: "cis_debian_12"
  file: "cis_debian_12.yml"
  version: "0.1"
  name: "Center for Internet Security Debian Linux 12 Benchmark v1.1.0"
  description: "This document provide prescriptive guidance for establishing a secure configuration posture for Debian 12. This version is pursuing the best guidance for server so there is level 1 and level 2 rule. It's also applicable to workstation but not guarantee for the current version."
  references:
    - https://www.cisecurity.org/cis-benchmarks

requirements:
  title:  "Check of the Debian version"
  description: "Requirements for running the SCA scan"
  condition: all
  rules:
    - "f:/etc/debian_version -> r:12\\."
    - "f:/proc/sys/kernel/ostype -> r:Linux"
    - "f:/etc/os-release -> r:NAME && r:Debian"
    - "f:/etc/os-release -> r:Version= && r:12"

checks:

# 1 - Initial Setup
# 1.1 - Filesystem
# 1.1.1 - Configure filesystem kernel modules
#
#
# 1.1.1.1 Ensure cramfs kernel module is not available. (Automated)
  - id: 1111
    title: "Ensure cramfs kernel module is not available."
    description: "The cramfs filesystem type is a compressed read-only Linux filesystem embedded in small footprint systems. A cramfs image can be used without having to first decompress the image."
    rationale : "Removing support for unneeded filesystem types reduces the local attack surface of the system. If this filesystem type is not needed, disable it."
    remediation: "Create or edit a file in /etc/modprobe.d/ .Add the following lines in it `install cramfs /bin/false or /bin.true` and `blacklist cramfs`. Then run `modprobe -r cramfs 2>/dev/null; rmmod cramfs 2>/dev/null` to remove cramfs from the kernel."
    level: "Level 1"
    references: 
      - ""
    compliance:
      - cis: ["1.1.1.1"]
      - others: ["unknow"]
    condition: all
    rules: 
      - "f:/etc/modprobe.d/* -> r:^\s*install\s+cramfs\s+/bin/false"
      - "f:/etc/modprobe.d/* -> r:^\s*blacklist\s+cramfs"
      - 'not c:lsmod cramfs -> r:^cramfs\s'

# 1.1.1.2 Ensure freevxfs kernel module is not available. (Automated)
  - id: 1112
    title: "Ensure freevxfs kernel module is not available."
    description: "The freevxfs filesystem type is a free version of the Veritas type filesystem. This is the primary filesystem type for HP-UX operating systems."
    rationale : "Removing support for unneeded filesystem types reduces the local attack surface of the system. If this filesystem type is not needed, disable it."
    remediation: "Create or edit a file in /etc/modprobe.d/ .Add the following lines in it `install freevxfs /bin/(false|true)` and `blacklist freevxfs`. Then run `modprobe -r freevxfs 2>/dev/null; rmmod freevxfs 2>/dev/null` to remove freevxfs from the kernel."
    level: "Level 1"
    references: 
      - ""
    compliance:
      - cis: ["1.1.1.2"]
      - others: ["unknow"]
    condition: all
    rules: 
      - "f:/etc/modprobe.d/* -> r:^\s*install\s+freevxfs\s+/bin/(false|true)"
      - "f:/etc/modprobe.d/* -> r:^\s*blacklist\s+freevxfs"
      - 'not c:lsmod freevxfs -> r:^freevxfs\s'

# 1.1.1.3 Ensure hfs kernel module is not available. (Automated)
  - id: 1113
    title: "Ensure hfs kernel module is not available."
    description: "The hfs filesystem type is a hierarchical filesystem that allows you to mount Mac OS filesystems."
    rationale : "Removing support for unneeded filesystem types reduces the local attack surface of the system. If this filesystem type is not needed, disable it."
    remediation: "Create or edit a file in /etc/modprobe.d/ .Add the following lines in it `install hfs /bin/(false|true)` and `blacklist hfs`. Then run `modprobe -r hfs 2>/dev/null; rmmod hfs 2>/dev/null` to remove hfs from the kernel."
    level: "Level 1"
    references: 
      - ""
    compliance:
      - cis: ["1.1.1.3"]
      - others: ["unknow"]
    condition: all
    rules: 
      - "f:/etc/modprobe.d/* -> r:^\s*install\s+hfs\s+/bin/(false|true)"
      - "f:/etc/modprobe.d/* -> r:^\s*blacklist\s+hfs"
      - 'not c:lsmod hfs -> r:^hfs\s'

# 1.1.1.4 Ensure hfsplus  kernel module is not available. (Automated)
  - id: 1114
    title: "Ensure hfs kernel module is not available."
    description: "The hfsplus filesystem type is a hierarchical filesystem that allows you to mount Mac OS filesystems."
    rationale : "Removing support for unneeded filesystem types reduces the local attack surface of the system. If this filesystem type is not needed, disable it."
    remediation: "Create or edit a file in /etc/modprobe.d/ .Add the following lines in it `install hfsplus /bin/(false|true)` and `blacklist hfsplus`. Then run `modprobe -r hfsplus 2>/dev/null; rmmod hfsplus 2>/dev/null` to remove hfs from the kernel."
    level: "Level 1"
    references: 
      - ""
    compliance:
      - cis: ["1.1.1.4"]
      - others: ["unknow"]
    condition: all
    rules: 
      - "f:/etc/modprobe.d/* -> r:^\s*install\s+hfsplus\s+/bin/(false|true)"
      - "f:/etc/modprobe.d/* -> r:^\s*blacklist\s+hfsplus"
      - 'not c:lsmod hfsplus -> r:^hfsplus\s'

# 1.1.1.5 Ensure jffs2 kernel module is not available. (Automated)
  - id: 1115
    title: "Ensure hfs kernel module is not available."
    description: "The jffs2 (journaling flash filesystem 2) filesystem type is a log-structured filesystem used in flash memory devices."
    rationale : "Removing support for unneeded filesystem types reduces the local attack surface of the system. If this filesystem type is not needed, disable it."
    remediation: "Create or edit a file in /etc/modprobe.d/ .Add the following lines in it `install jffs2 /bin/(false|true)` and `blacklist jffs2`. Then run `modprobe -r jffs2 2>/dev/null; rmmod jffs2 2>/dev/null` to remove hfs from the kernel."
    level: "Level 1"
    references: 
      - ""
    compliance:
      - cis: ["1.1.1.5"]
      - others: ["unknow"]
    condition: all
    rules: 
      - "f:/etc/modprobe.d/* -> r:^\s*install\s+jffs2\s+/bin/(false|true)"
      - "f:/etc/modprobe.d/* -> r:^\s*blacklist\s+jffs2"
      - 'not c:lsmod jffs2 -> r:^jffs2\s'

# 1.1.1.6 Ensure overlayfs kernel module is not available. (Automated)
  - id: 1116
    title: "Ensure overlayfs kernel module is not available."
    description: "The overlayfs is a Linux filesystem that layers multiple filesystems to create a single unified view which allows a user to merge several mount points into a unified filesystem."
    rationale : "The overlayfs has known CVE's: CVE-2023-32629, CVE-2023-2640, CVE-2023-0386. Disabling the overlayfs reduces the local attack surface by removing support for unnecessary filesystem types and mitigates potential risks associated with unauthorized execution of setuid files, enhancing the overall system security."
    remediation: "Create or edit a file in /etc/modprobe.d/ .Add the following lines in it `install overlayfs /bin/(false|true)` and `blacklist overlayfs`. Then run `modprobe -r overlayfs 2>/dev/null; rmmod overlayfs 2>/dev/null` to remove hfs from the kernel."
    level: "Level 1"
    references: 
      - ""
    compliance:
      - cis: ["1.1.1.6"]
      - others: ["unknow"]
    condition: all
    rules: 
      - "f:/etc/modprobe.d/* -> r:^\s*install\s+overlayfs\s+/bin/(false|true)"
      - "f:/etc/modprobe.d/* -> r:^\s*blacklist\s+overlayfs"
      - 'not c:lsmod overlayfs -> r:^overlayfs\s'

# 1.1.1.7 Ensure squashfs kernel module is not available. (Automated)
  - id: 1117
    title: "Ensure squashfs kernel module is not available."
    description: "The squashfs filesystem type is a compressed read-only Linux filesystem embedded in small footprint systems. A squashfs image can be used without having to first decompress the image."
    rationale : "Removing support for unneeded filesystem types reduces the local attack surface of the system. If this filesystem type is not needed, disable it."
    remediation: "Create or edit a file in /etc/modprobe.d/ .Add the following lines in it `install squashfs /bin/(false|true)` and `blacklist squashfs`. Then run `modprobe -r squashfs 2>/dev/null; rmmod squashfs 2>/dev/null` to remove hfs from the kernel."
    level: "Level 1"
    references: 
      - ""
    compliance:
      - cis: ["1.1.1.7"]
      - others: ["unknow"]
    condition: all
    rules: 
      - "f:/etc/modprobe.d/* -> r:^\s*install\s+squashfs\s+/bin/(false|true)"
      - "f:/etc/modprobe.d/* -> r:^\s*blacklist\s+squashfs"
      - 'not c:lsmod squashfs -> r:^squashfs\s'

# 1.1.1.8 Ensure udf kernel module is not available. (Automated)
  - id: 1118
    title: "Ensure udf kernel module is not available."
    description: "The udf filesystem type is the universal disk format used to implement ISO/IEC 13346 and ECMA-167 specifications. This is an open vendor filesystem type for data storage on a broad range of media. This filesystem type is necessary to support writing DVDs and newer optical disc formats."
    rationale : "Removing support for unneeded filesystem types reduces the local attack surface of the system. If this filesystem type is not needed, disable it."
    remediation: "Create or edit a file in /etc/modprobe.d/ .Add the following lines in it `install udf /bin/(false|true)` and `blacklist udf`. Then run `modprobe -r udf 2>/dev/null; rmmod udf 2>/dev/null` to remove hfs from the kernel."
    level: "Level 1"
    references: 
      - ""
    compliance:
      - cis: ["1.1.1.8"]
      - others: ["unknow"]
    condition: all
    rules: 
      - "f:/etc/modprobe.d/* -> r:^\s*install\s+udf\s+/bin/(false|true)"
      - "f:/etc/modprobe.d/* -> r:^\s*blacklist\s+udf"
      - 'not c:lsmod udf -> r:^udf\s'

# 1.1.1.9 Ensure usb-storage kernel module is not available. (Automated)
  - id: 1119
    title: "Ensure usb-storage kernel module is not available."
    description: "USB storage provides a means to transfer and store files ensuring persistence and availability of the files independent of network connection status. Its popularity and utility has led to USB-based malware being a simple and common means for network infiltration and a first step to establishing a persistent threat within a networked environment."
    rationale : "Restricting USB access on the system will decrease the physical attack surface for a device and diminish the possible vectors to introduce malware."
    remediation: "Create or edit a file in /etc/modprobe.d/ .Add the following lines in it `install usb-storage /bin/(false|true)` and `blacklist usb-storage`. Then run `modprobe -r usb-storage 2>/dev/null; rmmod usb-storage 2>/dev/null` to remove hfs from the kernel."
    level: "Level 1"
    references: 
      - ""
    compliance:
      - cis: ["1.1.1.9"]
      - others: ["unknow"]
    condition: all
    rules: 
      - "f:/etc/modprobe.d/* -> r:^\s*install\s+usb-storage\s+/bin/(false|true)"
      - "f:/etc/modprobe.d/* -> r:^\s*blacklist\s+usb-storage"
      - 'not c:lsmod usb-storage -> r:^usb-storage\s'

# 1.1.1.10 Ensure unused filesystems kernel modules are not available. (Manual)
  - id: 11110
    title: "Ensure unused filesystems are not available."

# 1.1.2 Configure filesystem partition
# 1.1.2.1 Configure /tmp
#
#

# NOT FINISHED

  - id: 11211
    title: "Ensure /tmp is a separate partition."
    description: "The /tmp directory is a world-writable directory used for temporary storage by all users and some applications"
    rationale: ""
    remediation: ""
    level: "Level 1"
    references:
      - ""
    compliance:
      - cis: ["1.1.2.1.1"]
      - others: [""] 
    condition:
    rules:
      - 'c:findmnt -kn /tmp -> r:^\s*/tmp\s'
      - 'c:systemctl is-enabled tmp.mount -> !r:maskend|disabled && r:generated|enabled'

# 

